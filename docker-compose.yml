version: "3.8"

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  db:
    image: postgres:15-alpine
    container_name: gmaps-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-gmaps}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gmaps_secret}
      POSTGRES_DB: ${POSTGRES_DB:-gmaps}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gmaps}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gmaps-network

  # ===========================================
  # Redis - Cache & Deduplication
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: gmaps-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    # Port not exposed to host - only accessible within gmaps-network
    # Manager/worker connect via redis:6379 internally
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gmaps-network

  # ===========================================
  # RabbitMQ - Job Queue
  # ===========================================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: gmaps-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-gmaps}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-gmaps_secret}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "127.0.0.1:15672:15672"  # Management UI (localhost only)
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - gmaps-network

  # ===========================================
  # Database Migrations
  # ===========================================
  migrate:
    image: migrate/migrate
    container_name: gmaps-migrate
    volumes:
      - ./scripts/migrations:/migrations:ro
    command: >
      -path=/migrations
      -database=postgres://${POSTGRES_USER:-gmaps}:${POSTGRES_PASSWORD:-gmaps_secret}@db:5432/${POSTGRES_DB:-gmaps}?sslmode=disable
      up
    depends_on:
      db:
        condition: service_healthy
    networks:
      - gmaps-network
    profiles:
      - legacy

  # ===========================================
  # Google Maps Scraper - Web UI Mode (Legacy)
  # Runs both web UI and scraping in same process
  # ===========================================
  scraper-web:
    build:
      context: .
      dockerfile: Dockerfile.rod
    container_name: gmaps-web
    command:
      - "-web"
      - "-addr=:8080"
      - "-dsn=postgres://${POSTGRES_USER:-gmaps}:${POSTGRES_PASSWORD:-gmaps_secret}@db:5432/${POSTGRES_DB:-gmaps}?sslmode=disable"
      - "-c=${CONCURRENCY:-4}"
      - "-depth=${DEPTH:-10}"
    ports:
      - "${WEB_PORT:-8080}:8080"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-gmaps}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gmaps_secret}
      - POSTGRES_DB=${POSTGRES_DB:-gmaps}
    volumes:
      - scraper_data:/data
      - ./queries:/queries:ro
      - ./results:/results
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - gmaps-network
    profiles:
      - legacy  # Only start with: docker compose --profile legacy up
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # ===========================================
  # Manager (Web UI + API Only - No Scraping)
  # New architecture: separates management from workers
  # ===========================================
  manager:
    build:
      context: .
      dockerfile: Dockerfile.rod
    image: ${SPAWNER_IMAGE:-gmaps-scraper-rod:latest}
    container_name: gmaps-manager
    command:
      - "-manager"
      - "-addr=:8080"
      - "-dsn=postgres://${POSTGRES_USER:-gmaps}:${POSTGRES_PASSWORD:-gmaps_secret}@db:5432/${POSTGRES_DB:-gmaps}?sslmode=disable"
      - "-redis-addr=redis:6379"
      - "-rabbitmq-url=amqp://${RABBITMQ_USER:-gmaps}:${RABBITMQ_PASSWORD:-gmaps_secret}@rabbitmq:5672/"
      - "-static-folder=/usr/share/gmaps-scraper/static"
      # ProxyGate configuration
      - "-proxygate"
      - "-proxygate-addr=:8081"
      # Auto-spawn worker configuration
      - "-spawner=docker"
      - "-spawner-image=${SPAWNER_IMAGE:-gmaps-scraper-rod:latest}"
      - "-spawner-network=${COMPOSE_PROJECT_NAME:-gmaps}_gmaps-network"
      - "-spawner-manager-url=http://manager:8080"
      - "-spawner-concurrency=${SPAWNER_CONCURRENCY:-4}"
      - "-spawner-max-workers=${SPAWNER_MAX_WORKERS:-5}"
      - "-spawner-auto-remove=true"
    ports:
      - "${WEB_PORT:-8080}:8080"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-gmaps}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gmaps_secret}
      - POSTGRES_DB=${POSTGRES_DB:-gmaps}
      - API_TOKEN=${API_TOKEN}
      # Spawner configuration (can be customized via .env)
      - SPAWNER_IMAGE=${SPAWNER_IMAGE:-gmaps-scraper-rod:latest}
      - SPAWNER_MAX_WORKERS=${SPAWNER_MAX_WORKERS:-5}
      - SPAWNER_CONCURRENCY=${SPAWNER_CONCURRENCY:-4}
    volumes:
      - manager_data:/data
      - ./results:/results
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gmaps-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # ===========================================
  # Scraper Worker (New Distributed Architecture)
  # Claims jobs from RabbitMQ queue, processes independently
  # Scale with: docker compose up --scale worker=N
  # ===========================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile.rod
    image: ${SPAWNER_IMAGE:-gmaps-scraper-rod:latest}
    command:
      - "-worker"
      - "-manager-url=http://manager:8080"
      - "-redis-addr=redis:6379"
      - "-rabbitmq-url=amqp://${RABBITMQ_USER:-gmaps}:${RABBITMQ_PASSWORD:-gmaps_secret}@rabbitmq:5672/"
      - "-c=${CONCURRENCY:-4}"
      - "-proxies=socks5://manager:8081"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-gmaps}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gmaps_secret}
      - API_TOKEN=${API_TOKEN}
    volumes:
      - worker_data:/data
      - ./results:/results
    depends_on:
      manager:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gmaps-network
    deploy:
      mode: replicated
      replicas: ${WORKER_COUNT:-1}
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ===========================================
  # Scraper Worker (Legacy Distributed Mode)
  # Connects directly to database
  # ===========================================
  worker-legacy:
    build:
      context: .
      dockerfile: Dockerfile.rod
    command:
      - "-dsn=postgres://${POSTGRES_USER:-gmaps}:${POSTGRES_PASSWORD:-gmaps_secret}@db:5432/${POSTGRES_DB:-gmaps}?sslmode=disable"
      - "-c=${CONCURRENCY:-4}"
      - "-depth=${DEPTH:-10}"
      - "-produce-only=false"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-gmaps}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gmaps_secret}
    volumes:
      - ./results:/results
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - gmaps-network
    profiles:
      - legacy-distributed  # Only start with: docker compose --profile legacy-distributed up
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

volumes:
  postgres_data:
    driver: local
    # Data persists across redeploys. Only deleted with: docker volume rm
  redis_data:
    driver: local
    # Redis persistence for cache and deduplication state
  rabbitmq_data:
    driver: local
    # RabbitMQ persistence for job queue state
  scraper_data:
    driver: local
  manager_data:
    driver: local
  worker_data:
    driver: local

networks:
  gmaps-network:
    driver: bridge
